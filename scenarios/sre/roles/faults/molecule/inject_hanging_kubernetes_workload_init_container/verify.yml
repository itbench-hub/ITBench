---
- name: Verify that fault injection succeeded
  hosts:
    - environment
  tasks:
    - name: Retrieve workload
      kubernetes.core.k8s_info:
        kubeconfig: "{{ cluster.kubeconfig }}"
        api_version: apps/v1
        kind: Deployment
        name: compromised-workload
        namespace: hanging-kubernetes-workload-init-container-test
      register: faults_deployment

    - name: Validate that init container was added
      ansible.builtin.assert:
        that:
          - faults_deployment.resources[0].spec.template.spec.initContainers is defined
          - faults_deployment.resources[0].spec.template.spec.initContainers | ansible.builtin.length == 1
        fail_msg: Init container not found. Fault injection failed.
        success_msg: Init container found.

    - name: Retrieve pods
      kubernetes.core.k8s_info:
        kubeconfig: "{{ cluster.kubeconfig }}"
        api_version: v1
        kind: Pod
        namespace: hanging-kubernetes-workload-init-container-test
        label_selectors:
          - app.kubernetes.io/name=compromised-workload
      register: faults_pods

    - name: Validate that pods are stuck in init phase
      ansible.builtin.assert:
        that:
          - faults_pods.resources | ansible.builtin.length == 2
          - faults_pods.resources | ansible.builtin.selectattr('status.phase', '==', 'Pending') | ansible.builtin.length == 1
        fail_msg: Stuck pods not found. Fault injection failed.
        success_msg: Stuck pods found.
