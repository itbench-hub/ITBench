---
{# Configuration is pre-merged in Ansible task from defaults + scenario overrides #}
components:
  accounting:
    replicas: {{ applications_otel_demo_configuration.accounting.replicas }}
{% if applications_otel_demo_configuration.accounting.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.accounting.resources | to_nice_yaml | indent(6, first=True) }}
{% else %}
    resources:
      limits:
        memory: 200Mi
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1654
  ad:
    replicas: {{ applications_otel_demo_configuration.ad.replicas }}
{% if applications_otel_demo_configuration.ad.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.ad.resources | to_nice_yaml | indent(6, first=True) }}
{% else %}
    resources:
      limits:
        memory: 512Mi
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  cart:
    replicas: {{ applications_otel_demo_configuration.cart.replicas }}
{% if applications_otel_demo_configuration.cart.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.cart.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  checkout:
    replicas: {{ applications_otel_demo_configuration.checkout.replicas }}
{% if applications_otel_demo_configuration.checkout.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.checkout.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  currency:
    replicas: {{ applications_otel_demo_configuration.currency.replicas }}

{% if applications_otel_demo_configuration.currency.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.currency.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  email:
    replicas: {{ applications_otel_demo_configuration.email.replicas }}

{% if applications_otel_demo_configuration.email.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.email.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  flagd:
    replicas: {{ applications_otel_demo_configuration.flagd.replicas }}

{% if applications_otel_demo_configuration.flagd.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.flagd.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  fraud-detection:
    replicas: {{ applications_otel_demo_configuration.fraud_detection.replicas }}
{% if applications_otel_demo_configuration.fraud_detection.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.fraud_detection.resources | to_nice_yaml | indent(6, first=True) }}
{% else %}
    resources:
      limits:
        memory: 512Mi
      requests:
        memory: 256Mi
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  frontend:
    replicas: {{ applications_otel_demo_configuration.frontend.replicas }}
{% if applications_otel_demo_configuration.frontend.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.frontend.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  frontend-proxy:
    replicas: {{ applications_otel_demo_configuration.frontend_proxy.replicas }}

{% if applications_otel_demo_configuration.frontend_proxy.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.frontend_proxy.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  image-provider:
    replicas: {{ applications_otel_demo_configuration.image_provider.replicas }}

{% if applications_otel_demo_configuration.image_provider.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.image_provider.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 101
  kafka:
    replicas: {{ applications_otel_demo_configuration.kafka.replicas }}
{% if applications_otel_demo_configuration.kafka.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.kafka.resources | to_nice_yaml | indent(6, first=True) }}
{% else %}
    resources:
      limits:
        memory: 1024Mi
      requests:
        memory: 512Mi
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  load-generator:
    replicas: {{ applications_otel_demo_configuration.load_generator.replicas }}
{% if applications_otel_demo_configuration.load_generator.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.load_generator.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    envOverrides:
      - name: LOCUST_BROWSER_TRAFFIC_ENABLED
        value: |-
          {{
            applications_configuration.opentelemetryDemo.configuration.load_generator.browser_traffic_enabled |
            ansible.builtin.default(false) |
            ansible.builtin.string
          }}
      - name: LOCUST_SPAWN_RATE
        value: |-
          {{
            applications_configuration.opentelemetryDemo.configuration.load_generator.users_spawn_rate |
            ansible.builtin.default(5) |
            ansible.builtin.string
          }}
      - name: LOCUST_USERS
        value: |-
          {{
            applications_configuration.opentelemetryDemo.configuration.load_generator.users |
            ansible.builtin.default(50) |
            ansible.builtin.string
          }}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  llm:
    replicas: {{ applications_otel_demo_configuration.llm.replicas }}
{% if applications_otel_demo_configuration.llm.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.llm.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  payment:
    replicas: {{ applications_otel_demo_configuration.payment.replicas }}

{% if applications_otel_demo_configuration.payment.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.payment.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  postgresql:
    replicas: {{ applications_otel_demo_configuration.postgresql.replicas }}

{% if applications_otel_demo_configuration.postgresql.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.postgresql.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  product-catalog:
    replicas: {{ applications_otel_demo_configuration.product_catalog.replicas }}
{% if applications_otel_demo_configuration.product_catalog.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.product_catalog.resources | to_nice_yaml | indent(6, first=True) }}
{% else %}
    resources:
      limits:
        memory: 160Mi
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  product-reviews:
    replicas: {{ applications_otel_demo_configuration.product_reviews.replicas }}
{% if applications_otel_demo_configuration.product_reviews.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.product_reviews.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  quote:
    replicas: {{ applications_otel_demo_configuration.quote.replicas }}

{% if applications_otel_demo_configuration.quote.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.quote.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
  recommendation:
    replicas: {{ applications_otel_demo_configuration.recommendation.replicas }}
{% if applications_otel_demo_configuration.recommendation.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.recommendation.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
{% if applications_cluster.platform == "openshift" %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  shipping:
    replicas: {{ applications_otel_demo_configuration.shipping.replicas }}

{% if applications_otel_demo_configuration.shipping.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.shipping.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
{% if applications_cluster.platform == "openshift" %}
  valkey-cart:
    replicas: {{ applications_otel_demo_configuration.valkey_cart.replicas }}

{% if applications_otel_demo_configuration.valkey_cart.resources is defined %}
    resources:
{{ applications_otel_demo_configuration.valkey_cart.resources | to_nice_yaml | indent(6, first=True) }}
{% endif %}
    podAnnotations:
      openshift.io/required-scc: restricted-v2
{% endif %}
    podSecurityContext:
      runAsGroup: 1000
      runAsNonRoot: true
      runAsUser: 999
opentelemetry-collector:
  config:
    connectors:
      spanmetrics:
        dimensions:
          - name: namespace
            default: {{ applications_managers.opentelemetry_demo.kubernetes.namespace }}
    exporters:
      clickhouse:
        username: {{ tools_clickhouse_username }}
        password: {{ tools_clickhouse_password }}
        endpoint: {{ tools_clickhouse_endpoint.http }}
        logs_table_name: otel_demo_logs
        traces_table_name: otel_demo_traces
      opensearch:
        http:
          endpoint: http://opensearch-master.opensearch.svc.cluster.local:9200
      otlp:
        endpoint: {{ tools_jaeger_endpoint.collector.grpc }}
      otlphttp/prometheus:
        endpoint: {{ tools_prometheus_endpoint.http }}
      prometheus:
        endpoint: 0.0.0.0:8888
    service:
      pipelines:
        logs:
          exporters:
            - clickhouse
            - debug
        metrics:
          exporters:
            - debug
            - prometheus
        traces:
          exporters:
            - clickhouse
            - debug
            - otlp
            - spanmetrics
      telemetry:
        metrics:
          level: detailed
          readers:
            - pull:
                exporter:
                  prometheus:
                    host: 0.0.0.0
                    port: 8889
  mode: deployment
  presets:
    clusterMetrics:
      enabled: false
    hostMetrics:
      enabled: false
    kubeletMetrics:
      enabled: false
  serviceMonitor:
    enabled: true
    metricsEndpoints:
      - port: metrics
      - port: telemetry
  resources:
    limits:
      memory: 512Mi
    requests:
      memory: 256Mi
{% if applications_cluster.platform == "openshift" %}
  podAnnotations:
    openshift.io/required-scc: restricted-v2
{% endif %}
  ports:
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    metrics:
      enabled: true
    telemetry:
      enabled: true
      containerPort: 8889
      servicePort: 8889
      protocol: TCP
    zipkin:
      enabled: false
grafana:
  enabled: false
jaeger:
  enabled: false
opensearch:
  enabled: false
prometheus:
  enabled: false
