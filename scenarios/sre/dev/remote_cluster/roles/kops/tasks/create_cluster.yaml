---
- name: Create cluster configuration ({{ cluster_name }})
  ansible.builtin.command:
    argv:
      - kops
      - create
      - cluster
      - "{{ cluster_name }}"
      - --cloud
      - aws
      - --zones
      - "{{ kops_cluster.aws.zones | join(',') }}"
      - --ssh-public-key
      - "{{ kops_cluster.ssh.public_key_path }}"
      - --control-plane-size
      - "{{ kops_cluster.nodes.control.instance_type }}"
      - --control-plane-count
      - "{{ kops_cluster.nodes.control.count }}"
      - --node-size
      - "{{ kops_cluster.nodes.worker.instance_type }}"
      - --node-count
      - "{{ kops_cluster.nodes.worker.count }}"
      - --networking
      - "{{ kops_cluster.networking.mode }}"
      - --state
      - "{{ kops_state_store }}"
      - --channel
      - stable
      - --kubernetes-version
      - "{{ kops_cluster.kubernetes_version }}"
  register: kops_create_output
  changed_when: kops_create_output.rc == 0

- name: Apply Cilium changes to configuration
  ansible.builtin.command:
    argv:
      - kops
      - edit
      - cluster
      - --name
      - "{{ cluster_name }}"
      - --state
      - "{{ kops_state_store }}"
      - --set
      - spec.networking.cilium.cniExclusive=false
      - --set
      - spec.networking.cilium.bpfLBSockHostNSOnly=true
  register: kops_edit_output
  changed_when: kops_edit_output.rc == 0

- name: Get cluster configuration
  ansible.builtin.command:
    argv:
      - kops
      - get
      - cluster
      - --name
      - "{{ cluster_name }}"
      - --state
      - "{{ kops_state_store }}"
      - -o
      - yaml
  register: kops_cluster_config
  changed_when: false

- name: Save cluster configuration
  ansible.builtin.copy:
    content: "{{ kops_cluster_config.stdout }}"
    dest: /tmp/{{ cluster_name }}-config.yaml
    mode: "0644"

- name: Add ebtables hook to cluster configuration
  ansible.builtin.blockinfile:
    path: /tmp/{{ cluster_name }}-config.yaml
    marker: "  # {mark} ANSIBLE MANAGED BLOCK - ebtables"
    insertafter: "^spec:"
    block: |2
        hooks:
        - name: install-ebtables.service
          before:
            - kubelet.service
          roles:
            - Master
            - Node
          manifest: |
            [Unit]
            Description=Install ebtables and load kernel modules
            Before=kubelet.service

            [Service]
            Type=oneshot
            ExecStart=/bin/bash -c 'apt-get update -qq && apt-get install -y ebtables && modprobe ebtable_broute && modprobe ebtable_nat && grep -q ebtable_broute /etc/modules || echo ebtable_broute >> /etc/modules && grep -q ebtable_nat /etc/modules || echo ebtable_nat >> /etc/modules'
            RemainAfterExit=yes

            [Install]
            WantedBy=multi-user.target

- name: Apply updated cluster configuration
  ansible.builtin.command:
    argv:
      - kops
      - replace
      - -f
      - /tmp/{{ cluster_name }}-config.yaml
      - --state
      - "{{ kops_state_store }}"
      - --force
  register: kops_replace_output
  changed_when: kops_replace_output.rc == 0

- name: Remove cluster configuration file
  ansible.builtin.file:
    path: /tmp/{{ cluster_name }}-config.yaml
    state: absent

- name: Build cluster ({{ cluster_name }})
  ansible.builtin.command:
    argv:
      - kops
      - update
      - cluster
      - --name
      - "{{ cluster_name }}"
      - --state
      - "{{ kops_state_store }}"
      - --yes
      - --internal
  register: kops_update_output
  changed_when: kops_update_output.rc == 0

- name: Display build logs
  ansible.builtin.debug:
    var: kops_update_output.stdout_lines

- name: Export the kubeconfig
  ansible.builtin.command:
    argv:
      - kops
      - export
      - --name
      - "{{ cluster_name }}"
      - kubecfg
      - --admin
      - --state
      - "{{ kops_state_store }}"
      - --kubeconfig
      - /tmp/{{ cluster_name }}.yaml
  register: kops_export_output
  changed_when: kops_export_output.rc == 0

- name: Validate cluster ({{ cluster_name }})
  ansible.builtin.command:
    argv:
      - kops
      - validate
      - cluster
      - --config
      - /tmp/{{ cluster_name }}.yaml
      - --state
      - "{{ kops_state_store }}"
  register: kops_validate_output
  changed_when: false
  retries: 60
  delay: 10
  until: kops_validate_output.rc == 0

- name: Display validation results
  ansible.builtin.debug:
    var: kops_validate_output.stdout_lines
  when:
    - kops_validate_output.rc == 0

- name: Setup Docker registry credentials
  ansible.builtin.include_tasks:
    file: setup_docker_registry.yaml
  when:
    - kops_validate_output.rc == 0
    - docker_registry is defined
    - docker_registry.username is defined
    - docker_registry.password is defined

- name: Display SSH information
  ansible.builtin.debug:
    msg: "You can now SSH into any of the nodes of your cluster, (most likely) using {{ kops_cluster.ssh.public_key_path | regex_replace('\\.[^.]*$', '') }}."
  when:
    - kops_validate_output.rc == 0

